{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-md p-8 mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">
    {{ _('Edit Item') if item else _('Add Item') }}
  </h2>

  <form id="itemForm"
        method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('edit_item', item_id=item.id) if item else url_for('add_item') }}"
        class="space-y-6">

    {% include 'item_form_fields.html' %}

    <div>
      <label class="block text-gray-700 font-medium mb-2">{{ _('Media') }}</label>
      <div id="drop-zone"
           class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer text-center text-gray-500 mb-4">
        {{ _('Click or drag files here to upload') }}
      </div>
      <input type="file" id="new_images" name="new_images" multiple class="hidden" accept="image/*,video/*">
      <div id="image-preview-container" class="flex flex-wrap gap-4"></div>

      <!-- Hidden inputs -->
      <input type="hidden" id="image_order" name="image_order" value="">
      <input type="hidden" id="main_image" name="main_image" value="">
      <input type="hidden" id="delete_list" name="delete_list" value="[]">
    </div>

    <div class="flex justify-end items-center gap-4 pt-6">
      <a href="{{ url_for('admin_panel') }}" class="px-5 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
        {{ _("Cancel") }}
      </a>
      <button type="submit" class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        {{ _("Save Changes") }}
      </button>
    </div>
  </form>
</div>

<script nonce="{{ csp_nonce() }}">
const dropZone = document.getElementById("drop-zone");
const fileInput = document.getElementById("new_images");
const container = document.getElementById("image-preview-container");
const mainInput = document.getElementById("main_image");
const imageOrderInput = document.getElementById("image_order");
const delete_list = document.getElementById("delete_list");

// --- Initialize existing images ---
window.existingImages = [];
{% for img in gallery %}
  window.existingImages.push({
    id: "{{ img.id }}",
    type: "{{ 'video' if img.filename.endswith(('.mp4','.webm','.mov')) else 'image' }}",
    filename: "{{ img.filename }}",
    thumb: "{{ img.thumb }}"
  });
{% endfor %}

// --- Drag & drop / click ---
dropZone.addEventListener("click", () => fileInput.click());
dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("border-green-500"); });
dropZone.addEventListener("dragleave", () => dropZone.classList.remove("border-green-500"));
dropZone.addEventListener("drop", e => {
  e.preventDefault();
  dropZone.classList.remove("border-green-500");
  handleFiles(e.dataTransfer.files);
});
fileInput.addEventListener("change", e => handleFiles(e.target.files));

function handleFiles(files) {
  [...files].forEach(file => {
    const reader = new FileReader();
    reader.onload = () => {
      const id = "new_" + crypto.randomUUID();
      const type = file.type.startsWith("video/") ? "video" : "image";
      window.existingImages.push({ id, thumb: reader.result, type, filename: file.name });
      renderImages();
    };
    reader.readAsDataURL(file);
  });
}

function renderImages() {
  container.innerHTML = "";
  window.existingImages.forEach(media => {
    const wrapper = document.createElement("div");
    wrapper.className = "relative w-32 h-32 cursor-move";
    wrapper.dataset.id = media.id;
    wrapper.draggable = true;

    let mediaEl;
    if (media.type === "video") {
      mediaEl = document.createElement("video");
      mediaEl.src = media.thumb.startsWith("data:") ? media.thumb : "/static/images/full/" + media.filename;
      mediaEl.controls = true;
      mediaEl.muted = true;
      mediaEl.className = "w-full h-full object-cover rounded border shadow-sm";
    } else {
      mediaEl = document.createElement("img");
      mediaEl.src = media.thumb.startsWith("data:") ? media.thumb : "/static/images/thumbs/" + (media.thumb || media.filename);
      mediaEl.className = "w-full h-full object-cover rounded border shadow-sm";
    }

    // â˜… main star
    const star = document.createElement("div");
    star.className = "absolute top-1 left-1 text-sm px-1 bg-black/50 text-yellow-400 rounded";
    star.textContent = "â˜…";

    // ðŸ—‘ delete
    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "ðŸ—‘";
    del.className = "absolute top-1 right-1 text-xs px-1 bg-black/60 text-red-300 rounded hover:bg-black";
    del.addEventListener("click", () => deleteMedia(media.id));

    wrapper.appendChild(mediaEl);
    wrapper.appendChild(star);
    wrapper.appendChild(del);
    container.appendChild(wrapper);
    enableDragging(wrapper);
  });
  updateOrder();
}

function deleteMedia(id) {
  if (!id.startsWith("new_")) {
    const current = JSON.parse(delete_list.value || "[]");
    current.push(id);
    delete_list.value = JSON.stringify(current);
  }
  window.existingImages = window.existingImages.filter(m => m.id !== id);
  renderImages();
}

let drag = null;
function enableDragging(el) {
  el.addEventListener("dragstart", () => drag = el);
  el.addEventListener("dragover", e => e.preventDefault());
  el.addEventListener("drop", () => {
    if (drag && drag !== el) container.insertBefore(drag, el);
    updateOrder();
  });
}

function updateOrder() {
  const ids = [...container.children].map(el => el.dataset.id);
  imageOrderInput.value = JSON.stringify(ids);
  mainInput.value = ids[0] || "";
}

// Initial render
renderImages();
</script>

{% endblock %}
