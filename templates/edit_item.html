{% extends "base.html" %}
{% block title %}{{ _("Edit Item") }}{% endblock %}

{% block content %}
<div class="max-w-5xl mx-auto px-6 py-10 bg-white shadow-md rounded-xl mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">
    {{ _("Edit Item") }}
  </h2>

  <form id="itemForm" method="POST" enctype="multipart/form-data"
      action="{{ url_for('edit_item', item_id=item['id']) if item else url_for('add_item') }}"
      class="space-y-6">

    {% include "item_form_fields.html" %}

    <div class="flex justify-end items-center gap-4 mt-8">
      <a href="{{ url_for('admin_panel') }}"
         class="px-5 py-2 rounded-lg border border-gray-300 text-gray-600 hover:bg-gray-100 transition">
        {{ _("Cancel") }}
      </a>
      <button type="submit"
              class="px-5 py-2 bg-green-600 text-white rounded-lg shadow hover:bg-green-700 transition">
        {{ _("Save Changes") }}
      </button>
    </div>
  </form>
</div>
<script nonce="{{ csp_nonce() }}">
const existingImages = {{ gallery|tojson }};
const mainInput = document.getElementById("main_image");
const imageOrderInput = document.getElementById("image_order");

function renderAllImages() {
  const container = document.getElementById("image-preview-container");
  container.innerHTML = "";

  existingImages.forEach(imgObj => {
    const wrapper = document.createElement("div");
    wrapper.className = "relative preview-item cursor-move";
    wrapper.dataset.id = imgObj.id;
    wrapper.draggable = true;

    const img = document.createElement("img");
    img.src = imgObj.thumb || "{{ url_for('static', filename='no-image.png') }}";

    img.className = "w-32 h-32 object-cover rounded border shadow-sm";

    const star = document.createElement("div");
    star.textContent = imgObj.is_main ? "★" : "☆";
    star.className = "absolute top-1 left-1 text-yellow-400 bg-black/50 px-1 rounded text-lg cursor-pointer";
    star.onclick = () => setMainImage(imgObj.id);

    wrapper.appendChild(img);
    wrapper.appendChild(star);
    container.appendChild(wrapper);

    addDragEvents(wrapper);
  });

  updateImageOrder();
}

let draggedItem = null;

function addDragEvents(el) {
  el.addEventListener("dragstart", (e) => {
    draggedItem = el;
    el.classList.add("opacity-50");
  });

  el.addEventListener("dragend", (e) => {
    el.classList.remove("opacity-50");
    draggedItem = null;
  });

  el.addEventListener("dragover", (e) => e.preventDefault());

  el.addEventListener("drop", (e) => {
    e.preventDefault();
    const container = document.getElementById("image-preview-container");
    if (draggedItem && draggedItem !== el) {
      container.insertBefore(draggedItem, el);
      updateImageOrder();
    }
  });
}

function setMainImage(id) {
  existingImages.forEach(img => img.is_main = (img.id === id));
  mainInput.value = id;
  renderAllImages();
}

function updateImageOrder() {
  const ids = [...document.querySelectorAll(".preview-item")].map(el => el.dataset.id);
  imageOrderInput.value = JSON.stringify(ids);
}

async function compressImage(file) {
  const img = await createImageBitmap(file);
  const canvas = document.createElement("canvas");

  const maxW = 1400;
  const scale = Math.min(1, maxW / img.width);
  canvas.width = img.width * scale;
  canvas.height = img.height * scale;

  canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

  return new Promise(resolve => {
    canvas.toBlob(blob => resolve(new File([blob], file.name, { type: "image/jpeg" })), "image/jpeg", 0.82);
  });
}

async function handleFiles(fileList) {
  for (let file of fileList) {
    const compressed = await compressImage(file);
    const reader = new FileReader();
    reader.onload = () => {
      existingImages.push({
        id: "new_" + crypto.randomUUID(),
        filename: file.name,
        thumb: reader.result,
        is_main: existingImages.length === 0
      });
      renderAllImages();
    };
    reader.readAsDataURL(compressed);
  }
}

document.addEventListener("DOMContentLoaded", () => {
  renderAllImages();
  if (!mainInput.value && existingImages.length > 0)
    setMainImage(existingImages[0].id);
});

document.getElementById("new_images").addEventListener("change", e => handleFiles(e.target.files));
</script>

{% endblock %}
