{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-md p-8 mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">
    {{ _('Edit Item') if item else _('Add Item') }}
  </h2>

  <form id="itemForm"
        method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('edit_item', item_id=item.id) if item else url_for('add_item') }}"
        class="space-y-6">

    {% include 'item_form_fields.html' %}

    <div>
      <label class="block text-gray-700 font-medium mb-2">{{ _('Media') }}</label>

      <!-- Drag & Drop Zone -->
      <div id="drop-zone"
           class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer text-center text-gray-500 mb-4">
        {{ _('Click or drag files here to upload') }}
      </div>

      <input type="file" id="new_images" name="new_images" multiple class="hidden" accept="image/*,video/*">

      <!-- ‚úÖ EXISTING GALLERY DISPLAY -->
      <div id="gallery" class="flex flex-wrap gap-4">
        {% for img in gallery %}
          <div class="img-box relative w-32 h-32 border rounded overflow-hidden" data-id="{{ img.id }}">
              <img src="{{ url_for('static', filename='images/thumbs/' + img.thumb) }}"
                   alt="{{ img.filename }}"
                   class="w-full h-full object-cover">
              <div class="absolute top-1 right-1 flex gap-1">
                  <span class="main-icon {% if img.is_main %}active{% endif %} cursor-default">‚≠ê</span>
                  <span class="delete-icon cursor-pointer text-red-500">üóëÔ∏è</span>
              </div>
          </div>
        {% endfor %}
      </div>

      <!-- Hidden inputs -->
      <input type="hidden" id="delete_list" name="delete_list" value="[]">
      <input type="hidden" id="image_order" name="image_order" value="">
    </div>

    <!-- Action buttons -->
    <div class="flex justify-end items-center gap-4 pt-6">
      <a href="{{ url_for('admin_panel') }}"
         class="px-5 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
        {{ _("Cancel") }}
      </a>
      <button type="submit"
              class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        {{ _("Save Changes") }}
      </button>
    </div>
  </form>
</div>

<!-- ‚úÖ GALLERY JS -->
<script nonce="{{ csp_nonce() }}">
document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.getElementById("gallery");
    const deleteListInput = document.getElementById("delete_list");
    const imageOrderInput = document.getElementById("image_order");

    let deleteList = [];
    let dragSrc = null;

    // --- Make images draggable ---
    function enableDragging() {
        gallery.querySelectorAll(".img-box").forEach(box => {
            box.setAttribute("draggable", true);

            box.addEventListener("dragstart", e => {
                dragSrc = box;
                e.dataTransfer.effectAllowed = "move";
                box.classList.add("opacity-50");
            });

            box.addEventListener("dragover", e => e.preventDefault());
            box.addEventListener("drop", e => {
                e.preventDefault();
                if (dragSrc && dragSrc !== box) {
                    gallery.insertBefore(dragSrc, box);
                    updateImageOrder();
                    updateMainImage();
                }
            });

            box.addEventListener("dragend", () => {
                box.classList.remove("opacity-50");
                dragSrc = null;
            });
        });
    }

    // --- Delete an image ---
    gallery.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-icon")) {
            const imgBox = e.target.closest(".img-box");
            const imgId = imgBox.dataset.id;

            imgBox.remove(); // remove visually

            // record deletions only for saved images
            if (!imgId.startsWith("new_")) {
                deleteList.push(parseInt(imgId));
                deleteListInput.value = JSON.stringify(deleteList);
            }

            updateImageOrder();
            updateMainImage();
        }
    });

    // --- Update image order ---
    function updateImageOrder() {
        const ids = [...gallery.querySelectorAll(".img-box")].map(b => b.dataset.id);
        imageOrderInput.value = JSON.stringify(ids);
    }

    // --- Always make first image main ---
    function updateMainImage() {
        gallery.querySelectorAll(".main-icon").forEach(i => i.classList.remove("active"));
        const firstBox = gallery.querySelector(".img-box");
        if (firstBox) {
            const star = firstBox.querySelector(".main-icon");
            if (star) star.classList.add("active");
        }
    }

    // Initialize
    enableDragging();
    updateImageOrder();
    updateMainImage();
});
</script>

{% endblock %}
