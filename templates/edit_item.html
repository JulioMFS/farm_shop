{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-md p-8 mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">
    {{ _('Edit Item') if item else _('Add Item') }}
  </h2>

  <form id="itemForm"
        method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('edit_item', item_id=item.id) if item else url_for('add_item') }}"
        class="space-y-6">

    {% include 'item_form_fields.html' %}

    <div>
      <label class="block text-gray-700 font-medium mb-2">{{ _('Media') }}</label>

      <!-- Drag & Drop Zone -->
      <div id="drop-zone"
           class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer text-center text-gray-500 mb-4">
        {{ _('Click or drag files here to upload') }}
      </div>

      <input type="file" id="new_images" name="new_images" multiple class="hidden" accept="image/*,video/*">

      <!-- EXISTING GALLERY DISPLAY -->
      <div id="gallery" class="flex flex-wrap gap-4">
        {% for img in gallery %}
          <div class="img-box relative w-32 h-32 border rounded overflow-hidden" data-id="{{ img.id }}">
              <img src="{{ url_for('static', filename=img.thumb) }}" loading="lazy" alt="" class="w-full h-full object-cover">
              <div class="absolute top-1 right-1 flex gap-1">
                  <span class="delete-icon cursor-pointer text-red-500">üóëÔ∏è</span>
              </div>
          </div>
        {% endfor %}
      </div>

      <!-- Hidden inputs -->
      <input type="hidden" id="delete_list" name="delete_list" value="[]">
      <input type="hidden" id="image_order" name="image_order" value="">
    </div>

    <!-- Action buttons -->
    <div class="flex justify-end items-center gap-4 pt-6">
      <a href="{{ url_for('admin_panel') }}"
         class="px-5 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
        {{ _("Cancel") }}
      </a>
      <button type="submit"
              class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        {{ _("Save Changes") }}
      </button>
    </div>
  </form>
</div>

<!-- GALLERY & DRAG-DROP JS -->
<script type="module" nonce="{{ csp_nonce() }}">
import { showLoading, hideLoading, previewLoading, startProgress, updateProgress, finishProgress } from "{{ url_for('static', filename='js/loader.js') }}";

// --- Resize image for preview ---
function resizeImage(file, maxWidth = 300) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onload = e => {
            const img = new Image();
            img.onload = () => {
                const scale = maxWidth / img.width;
                const canvas = document.createElement("canvas");
                canvas.width = maxWidth;
                canvas.height = img.height * scale;
                const ctx = canvas.getContext("2d");
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                canvas.toBlob(blob => resolve(blob), "image/jpeg", 0.7);
            };
            img.src = e.target.result;
        };
        reader.readAsDataURL(file);
    });
}

document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.getElementById("gallery");
    const deleteListInput = document.getElementById("delete_list");
    const imageOrderInput = document.getElementById("image_order");
    const dropZone = document.getElementById("drop-zone");
    const newImagesInput = document.getElementById("new_images");
    let deleteList = [];
    let dragSrc = null;

    // --- Enable dragging of gallery images ---
    function enableDragging() {
        gallery.querySelectorAll(".img-box").forEach(box => {
            box.setAttribute("draggable", true);
            box.addEventListener("dragstart", e => {
                dragSrc = box;
                e.dataTransfer.effectAllowed = "move";
                box.classList.add("opacity-50");
            });
            box.addEventListener("dragover", e => e.preventDefault());
            box.addEventListener("drop", e => {
                e.preventDefault();
                if (dragSrc && dragSrc !== box) {
                    gallery.insertBefore(dragSrc, box);
                    updateImageOrder();
                }
            });
            box.addEventListener("dragend", () => box.classList.remove("opacity-50"));
        });
    }

    // --- Delete an image ---
    gallery.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-icon")) {
            const imgBox = e.target.closest(".img-box");
            const imgId = imgBox.dataset.id;
            imgBox.remove();
            if (!imgId.startsWith("new_")) {
                deleteList.push(parseInt(imgId));
                deleteListInput.value = JSON.stringify(deleteList);
            }
            updateImageOrder();
        }
    });

    // --- Update hidden image_order field ---
    function updateImageOrder() {
        const ids = [...gallery.querySelectorAll(".img-box")].map(b => b.dataset.id);
        imageOrderInput.value = JSON.stringify(ids);
    }

    // --- Handle new files (images & videos) ---
    async function handleFiles(files) {
        if (!files || files.length === 0) return;

        const dataTransfer = new DataTransfer();
        [...newImagesInput.files].forEach(f => dataTransfer.items.add(f));
        [...files].forEach(f => dataTransfer.items.add(f));
        newImagesInput.files = dataTransfer.files;

        for (const file of files) {
            const div = document.createElement("div");
            div.className = "img-box relative w-32 h-32 border rounded overflow-hidden";
            div.dataset.id = "new_" + file.name;

            if (file.type.startsWith("image/")) {
                const blob = await resizeImage(file, 300);
                const url = URL.createObjectURL(blob);
                previewLoading();
                div.innerHTML = `
                    <img src="${url}" loading="lazy" alt="${file.name}" class="w-full h-full object-cover">
                    <div class="absolute top-1 right-1 flex gap-1">
                        <span class="delete-icon cursor-pointer text-red-500">üóëÔ∏è</span>
                    </div>
                `;
            } else if (file.type.startsWith("video/")) {
                const url = URL.createObjectURL(file);
                previewLoading();
                div.innerHTML = `
                    <video src="${url}" class="w-full h-full object-cover" controls></video>
                    <div class="absolute top-1 right-1 flex gap-1">
                        <span class="delete-icon cursor-pointer text-red-500">üóëÔ∏è</span>
                    </div>
                `;
            }

            gallery.appendChild(div);
            enableDragging();
            updateImageOrder();
        }
    }

    // --- Drop zone click opens file picker ---
    dropZone.addEventListener("click", () => newImagesInput.click());

    // --- Drag & drop events ---
    ["dragenter", "dragover"].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add("border-blue-400");
        });
    });
    dropZone.addEventListener("dragleave", e => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-400");
    });
    dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-400");
        handleFiles(e.dataTransfer.files);
    });

    // --- File input change ---
    newImagesInput.addEventListener("change", () => handleFiles(newImagesInput.files));

    // --- Form submission with progress ---
    const form = document.getElementById("itemForm");
    form.addEventListener("submit", (e) => {
        e.preventDefault();
        showLoading();
        startProgress();

        const formData = new FormData(form);
        const xhr = new XMLHttpRequest();
        xhr.open("POST", form.action, true);

        xhr.upload.addEventListener("progress", (evt) => {
            if (evt.lengthComputable) {
                const percent = Math.round((evt.loaded / evt.total) * 100);
                updateProgress(percent);
            }
        });

        xhr.onload = () => finishProgress();
        xhr.onerror = () => finishProgress();
        xhr.send(formData);
    });

    // --- Initialize gallery ---
    enableDragging();
    updateImageOrder();

    // --- Hide loader quickly after initial images (max 1.5s) ---
    showLoading();
    setTimeout(hideLoading, 1500);
});
</script>

{% endblock %}
