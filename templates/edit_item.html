{% extends "base.html" %}
{% block content %}

<div class="max-w-5xl mx-auto bg-white rounded-2xl shadow-md p-8 mt-8">
  <h2 class="text-2xl font-semibold text-gray-800 mb-6">
    {{ _('Edit Item') if item else _('Add Item') }}
  </h2>

  <form id="itemForm"
        method="POST"
        enctype="multipart/form-data"
        action="{{ url_for('edit_item', item_id=item.id) if item else url_for('add_item') }}"
        class="space-y-6">

    {% include 'item_form_fields.html' %}

    <div>
      <label class="block text-gray-700 font-medium mb-2">{{ _('Media') }}</label>

      <!-- Drag & Drop Zone -->
      <div id="drop-zone"
           class="w-full p-6 border-2 border-dashed border-gray-300 rounded-lg cursor-pointer text-center text-gray-500 mb-4">
        {{ _('Click or drag files here to upload') }}
      </div>

      <input type="file" id="new_images" name="new_images" multiple class="hidden" accept="image/*,video/*">

      <!-- EXISTING GALLERY DISPLAY -->
      <div id="gallery" class="flex flex-wrap gap-4">
        {% for img in gallery %}
          <div class="img-box relative w-32 h-32 border rounded overflow-hidden" data-id="{{ img.id }}">
              <img src="{{ url_for('static', filename=img.thumb) }}" alt="" class="w-full h-full object-cover">
              <div class="absolute top-1 right-1 flex gap-1">
                  <span class="delete-icon cursor-pointer text-red-500">ğŸ—‘ï¸</span>
              </div>
          </div>
        {% endfor %}
      </div>

      <!-- Hidden inputs -->
      <input type="hidden" id="delete_list" name="delete_list" value="[]">
      <input type="hidden" id="image_order" name="image_order" value="">
    </div>

    <!-- Action buttons -->
    <div class="flex justify-end items-center gap-4 pt-6">
      <a href="{{ url_for('admin_panel') }}"
         class="px-5 py-2 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-100 transition">
        {{ _("Cancel") }}
      </a>
      <button type="submit"
              class="px-5 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
        {{ _("Save Changes") }}
      </button>
    </div>
  </form>
</div>

<!-- GALLERY & DRAG-DROP JS -->
<script nonce="{{ csp_nonce() }}">
document.addEventListener("DOMContentLoaded", () => {
    const gallery = document.getElementById("gallery");
    const deleteListInput = document.getElementById("delete_list");
    const imageOrderInput = document.getElementById("image_order");
    const dropZone = document.getElementById("drop-zone");
    const newImagesInput = document.getElementById("new_images");

    let deleteList = [];
    let dragSrc = null;

    // --- Enable dragging of gallery images ---
    function enableDragging() {
        gallery.querySelectorAll(".img-box").forEach(box => {
            box.setAttribute("draggable", true);

            box.addEventListener("dragstart", e => {
                dragSrc = box;
                e.dataTransfer.effectAllowed = "move";
                box.classList.add("opacity-50");
            });

            box.addEventListener("dragover", e => e.preventDefault());

            box.addEventListener("drop", e => {
                e.preventDefault();
                if (dragSrc && dragSrc !== box) {
                    gallery.insertBefore(dragSrc, box);
                    updateImageOrder();
                    updateMainImage();
                }
            });

            box.addEventListener("dragend", () => {
                box.classList.remove("opacity-50");
                dragSrc = null;
            });
        });
    }

    // --- Delete an image ---
    gallery.addEventListener("click", (e) => {
        if (e.target.classList.contains("delete-icon")) {
            const imgBox = e.target.closest(".img-box");
            const imgId = imgBox.dataset.id;

            imgBox.remove();

            if (!imgId.startsWith("new_")) {
                deleteList.push(parseInt(imgId));
                deleteListInput.value = JSON.stringify(deleteList);
            }

            updateImageOrder();
            updateMainImage();
        }
    });

    // --- Update hidden image_order field ---
    function updateImageOrder() {
        const ids = [...gallery.querySelectorAll(".img-box")].map(b => b.dataset.id);
        imageOrderInput.value = JSON.stringify(ids);
    }

    // --- Set main image (first in gallery) ---
    function updateMainImage() {
        gallery.querySelectorAll(".img-box").forEach((box, idx) => {
            const star = box.querySelector(".main-icon");
            if (star) {
                if (idx === 0) {
                    star.classList.add("active");
                } else {
                    star.classList.remove("active");
                }
            }
        });
    }

    // --- Handle new files (images & videos) ---
    function handleFiles(files) {
        if (!files || files.length === 0) return;

        // Add new files to the real file input
        const dataTransfer = new DataTransfer();
        [...newImagesInput.files].forEach(f => dataTransfer.items.add(f));
        [...files].forEach(f => dataTransfer.items.add(f));
        newImagesInput.files = dataTransfer.files;

        [...files].forEach(file => {
            const div = document.createElement("div");
            div.className = "img-box relative w-32 h-32 border rounded overflow-hidden";
            div.dataset.id = "new_" + file.name;

            if (file.type.startsWith("image/")) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    div.innerHTML = `
                        <img src="${e.target.result}" alt="${file.name}" class="w-full h-full object-cover">
                        <div class="absolute top-1 right-1 flex gap-1">
                            <span class="delete-icon cursor-pointer text-red-500">ğŸ—‘ï¸</span>
                        </div>
                    `;
                    gallery.appendChild(div);
                    enableDragging();
                    updateImageOrder();
                    updateMainImage();
                };
                reader.readAsDataURL(file);
            } else if (file.type.startsWith("video/")) {
                const url = URL.createObjectURL(file);
                div.innerHTML = `
                    <video src="${url}" class="w-full h-full object-cover" controls></video>
                    <div class="absolute top-1 right-1 flex gap-1">
                        <span class="delete-icon cursor-pointer text-red-500">ğŸ—‘ï¸</span>
                    </div>
                `;
                gallery.appendChild(div);
                enableDragging();
                updateImageOrder();
                updateMainImage();
            }
        });
    }

    // --- Drop zone click opens file picker ---
    dropZone.addEventListener("click", () => newImagesInput.click());

    // --- Drag & drop events ---
    ["dragenter", "dragover"].forEach(evt => {
        dropZone.addEventListener(evt, e => {
            e.preventDefault();
            dropZone.classList.add("border-blue-400");
        });
    });

    dropZone.addEventListener("dragleave", e => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-400");
    });

    dropZone.addEventListener("drop", e => {
        e.preventDefault();
        dropZone.classList.remove("border-blue-400");
        handleFiles(e.dataTransfer.files);
    });

    // --- File input change (click upload) ---
    newImagesInput.addEventListener("change", () => handleFiles(newImagesInput.files));

    // --- Initialize ---
    enableDragging();
    updateImageOrder();
    updateMainImage();
});
</script>


{% endblock %}
